<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Peer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom animations, scrollbar, and tooltip */
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .spin {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #e5e7eb;
    }
    ::-webkit-scrollbar-thumb {
      background: #6b7280;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #4b5563;
    }
    [data-tooltip] {
      position: relative;
    }
    [data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 10;
      margin-bottom: 8px;
    }
    /* Skeleton loading */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
    }
    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    /* Dark mode adjustments */
    .dark ::-webkit-scrollbar-track {
      background: #374151;
    }
    .dark ::-webkit-scrollbar-thumb {
      background: #9ca3af;
    }
    .dark ::-webkit-scrollbar-thumb:hover {
      background: #d1d5db;
    }
    /* Notification animation */
    .notification-enter {
      animation: slideIn 0.3s ease-out;
    }
    .notification-exit {
      animation: slideOut 0.3s ease-in forwards;
    }
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateY(0); opacity: 1; }
      to { transform: translateY(-20px); opacity: 0; }
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen font-sans antialiased text-gray-900 dark:text-gray-100 transition-colors duration-300">
  <!-- Navigation Bar -->
  <nav class="bg-white dark:bg-gray-800 shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-500 to-indigo-600 bg-clip-text text-transparent">Peer Dashboard</h1>
        </div>
        <div class="flex items-center">
          <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition duration-200" data-tooltip="Toggle Dark Mode" aria-label="Toggle Dark Mode">
            <svg id="sunIcon" class="w-6 h-6 text-yellow-500 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            <svg id="moonIcon" class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <div class="flex flex-col h-[calc(100vh-4rem)] lg:flex-row max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Left Panel -->
    <div class="lg:flex-2 w-full lg:w-2/3 py-8 overflow-y-auto">
      <h2 class="text-3xl font-bold mb-6 bg-gradient-to-r from-blue-500 to-indigo-600 bg-clip-text text-transparent">Peer Configuration</h2>
      <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 mb-8 text-sm fade-in" id="configDisplay">
        <div class="space-y-4">
          <div class="h-4 w-1/2 rounded skeleton"></div>
          <div class="h-4 w-3/4 rounded skeleton"></div>
          <div class="h-4 w-2/3 rounded skeleton"></div>
        </div>
      </div>

      <h2 class="text-3xl font-bold mb-6 bg-gradient-to-r from-blue-500 to-indigo-600 bg-clip-text text-transparent">Active Peers</h2>
      <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 font-mono text-sm text-gray-700 dark:text-gray-300 fade-in" id="peersDisplay">
        <div class="space-y-4">
          <div class="h-4 w-1/2 rounded skeleton"></div>
          <div class="h-4 w-3/4 rounded skeleton"></div>
          <div class="h-4 w-2/3 rounded skeleton"></div>
        </div>
      </div>
    </div>

    <!-- Right Panel -->
    <div class="lg:flex-1 w-full lg:w-1/3 py-8 pl-8 lg:border-l border-gray-200 dark:border-gray-700 overflow-y-auto">
      <div id="notification" class="hidden fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg" role="alert"></div>
      <h2 class="text-3xl font-bold mb-6 bg-gradient-to-r from-blue-500 to-indigo-600 bg-clip-text text-transparent">Get Value</h2>
      <div class="mb-5">
        <label for="getKey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Key</label>
        <input type="text" id="getKey" placeholder="Enter key..." class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition duration-200" aria-describedby="getKeyHelp" />
        <p id="getKeyHelp" class="mt-1 text-xs text-gray-500 dark:text-gray-400">Enter the key to retrieve its value.</p>
      </div>
      <button onclick="getValue()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-3 rounded-lg hover:from-blue-600 hover:to-indigo-700 transition duration-200 font-medium mb-5" data-tooltip="Retrieve Value" aria-label="Get Value">Get Value</button>
      <div class="bg-gray-50 dark:bg-gray-700 shadow-inner rounded-lg p-5 font-mono text-sm text-gray-700 dark:text-gray-300 fade-in" id="getValueDisplay"></div>

      <h2 class="text-3xl font-bold mb-6 mt-8 bg-gradient-to-r from-blue-500 to-indigo-600 bg-clip-text text-transparent">Set Value</h2>
      <div class="mb-5">
        <label for="setKey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Key</label>
        <input type="text" id="setKey" placeholder="Enter key..." class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition duration-200" aria-describedby="setKeyHelp" />
        <p id="setKeyHelp" class="mt-1 text-xs text-gray-500 dark:text-gray-400">Enter the key to set.</p>
      </div>
      <div class="mb-5">
        <label for="setValue" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Value</label>
        <input type="text" id="setValue" placeholder="Enter value (string, number, or JSON)..." class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition duration-200" aria-describedby="setValueHelp" />
        <p id="setValueHelp" class="mt-1 text-xs text-gray-500 dark:text-gray-400">Enter a string, number, or JSON object.</p>
      </div>
      <button onclick="setValue()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-3 rounded-lg hover:from-blue-600 hover:to-indigo-700 transition duration-200 font-medium mb-5" data-tooltip="Set Value" aria-label="Set Value">Set Value</button>
      <div class="bg-gray-50 dark:bg-gray-700 shadow-inner rounded-lg p-5 font-mono text-sm text-gray-700 dark:text-gray-300 fade-in" id="setValueDisplay"></div>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:3000";

    // Dark mode toggle
    const themeToggle = document.getElementById('themeToggle');
    const sunIcon = document.getElementById('sunIcon');
    const moonIcon = document.getElementById('moonIcon');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (localStorage.theme === 'dark' || (!localStorage.theme && prefersDark)) {
      document.body.classList.add('dark');
      sunIcon.classList.remove('hidden');
      moonIcon.classList.add('hidden');
    }
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      localStorage.theme = document.body.classList.contains('dark') ? 'dark' : 'light';
      sunIcon.classList.toggle('hidden');
      moonIcon.classList.toggle('hidden');
    });

    // Notification helper
    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.classList.remove('hidden');
      notification.classList.add('notification-enter');
      setTimeout(() => {
        notification.classList.remove('notification-enter');
        notification.classList.add('notification-exit');
        setTimeout(() => {
          notification.classList.add('hidden');
          notification.classList.remove('notification-exit');
        }, 300);
      }, 3000);
    }

    function formatPeers(data) {
      let formatted = "";
      for (const key in data) {
        const { name, ip, port } = data[key];
        formatted += `${name}:\n  IP: ${ip}\n  Port: ${port}\n\n`;
      }
      return formatted.trim();
    }

    function renderConfig(config) {
      return `
        <div class="space-y-4">
          <details class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4" open>
            <summary class="font-semibold text-gray-800 dark:text-gray-200 cursor-pointer">Auto Discovery</summary>
            <ul class="list-disc list-inside ml-4 mt-2 text-gray-600 dark:text-gray-400">
              <li>Enabled: <span class="font-mono">${config.autoDiscoverPeers}</span></li>
              <li>Port: <span class="font-mono">${config.autoDiscoverPort}</span></li>
              <li>Subnet Mask: <span class="font-mono">${config.autoDiscoverSubnetMask}</span></li>
            </ul>
          </details>
          <details class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4" open>
            <summary class="font-semibold text-gray-800 dark:text-gray-200 cursor-pointer">Database Server</summary>
            <ul class="list-disc list-inside ml-4 mt-2 text-gray-600 dark:text-gray-400">
              <li>Port: <span class="font-mono">${config.dbServerPort}</span></li>
            </ul>
          </details>
          <details class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4" open>
            <summary class="font-semibold text-gray-800 dark:text-gray-200 cursor-pointer">Identity</summary>
            <ul class="list-disc list-inside ml-4 mt-2 text-gray-600 dark:text-gray-400">
              <li>Name: <span class="font-mono">${config.identity.name}</span></li>
              <li>IP: <span class="font-mono">${config.identity.ip}</span></li>
              <li>Port: <span class="font-mono">${config.identity.port}</span></li>
            </ul>
          </details>
          <details class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4" open>
            <summary class="font-semibold text-gray-800 dark:text-gray-200 cursor-pointer">Peers to Discover</summary>
            <ul class="list-disc list-inside ml-4 mt-2 text-gray-600 dark:text-gray-400">
              ${config.peersToDiscover.map(peer => `
                <li>
                  <span class="font-mono">${peer.name}</span>
                  <ul class="list-circle list-inside ml-6">
                    <li>IP: <span class="font-mono">${peer.ip}</span></li>
                    <li>Port: <span class="font-mono">${peer.port}</span></li>
                  </ul>
                </li>
              `).join('')}
            </ul>
          </details>
        </div>
      `;
    }

    async function fetchConfig() {
      const configDisplay = document.getElementById('configDisplay');
      try {
        const res = await fetch(`${API_BASE}/config`);
        const data = await res.json();
        configDisplay.innerHTML = renderConfig(data);
      } catch (err) {
        configDisplay.innerHTML = '<p class="text-red-500 dark:text-red-400">Error fetching config.</p>';
      }
    }

    async function fetchPeers() {
      const peersDisplay = document.getElementById('peersDisplay');
      try {
        const res = await fetch(`${API_BASE}/peers`);
        const data = await res.json();
        peersDisplay.textContent = formatPeers(data);
      } catch (err) {
        peersDisplay.innerHTML = '<p class="text-red-500 dark:text-red-400">Error fetching peers.</p>';
      }
    }

    async function getValue() {
      const key = document.getElementById('getKey').value.trim();
      const getValueDisplay = document.getElementById('getValueDisplay');
      if (!key) {
        showNotification("Please enter a key.");
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/get/${key}`);
        const data = await res.json();
        getValueDisplay.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        getValueDisplay.innerHTML = '<p class="text-red-500 dark:text-red-400">Error fetching value.</p>';
      }
    }

    async function setValue() {
      const key = document.getElementById('setKey').value.trim();
      const valueInput = document.getElementById('setValue').value.trim();
      const setValueDisplay = document.getElementById('setValueDisplay');
      if (!key || !valueInput) {
        showNotification("Please enter both key and value.");
        return;
      }
      let parsedValue;
      try {
        // Try parsing as JSON
        parsedValue = JSON.parse(valueInput);
      } catch (jsonErr) {
        // Not JSON, check if it's a number
        if (!isNaN(valueInput) && valueInput !== '') {
          parsedValue = Number(valueInput);
        } else if (valueInput === '') {
          showNotification("Value cannot be empty.");
          return;
        } else {
          // Treat as string
          parsedValue = valueInput;
        }
      }
      try {
        const res = await fetch(`${API_BASE}/set`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key, value: parsedValue })
        });
        const data = await res.json();
        setValueDisplay.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        setValueDisplay.innerHTML = '<p class="text-red-500 dark:text-red-400">Error setting value.</p>';
      }
    }

    fetchConfig();
    fetchPeers();
    setInterval(fetchPeers, 5000);
  </script>
</body>
</html>